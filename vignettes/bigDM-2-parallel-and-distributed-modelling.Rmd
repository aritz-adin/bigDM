---
title: "bigDM: parallel and distributed modelling"
author: "A. Adin, E. Orozco-Acosta, M.D. Ugarte"
date: "`r Sys.Date()`"
output:
  bookdown::html_document2:
    toc: true
    toc_float: yes
bibliography: REFERENCES.bib
link-citations: true
csl: apa.csl
vignette: >
  %\VignetteIndexEntry{bigDM2}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{css, echo = FALSE}
.indent {
 margin-left: 40px;
}
```

## Introduction {-#introduction}
When fitting both the disjoint and k-order neighbour models with the __bigDM__ package [@orozco2020;@orozco2022] parallel or distributed computation strategies can be performed to speed up computations by using the __future__ package [@bengtsson2020unifying]. 

Different computation strategies can be specified through the `plan` argument of the `CAR_INLA()` and `STCAR_INLA()` functions (available for __bigDM__ version 0.4 and higher). For further details about these strategies see the [documentation of the __future__ package](https://cran.r-project.org/web/packages/future/index.html)  and its corresponding vignettes.

* If `plan="sequential"` (default), the models are fitted sequentially and in the current R session (local machine).

* If `plan="cluster"`, multiple models can be fitted in parallel on external R sessions (local machine) or distributed in remote compute nodes. When using this option, the identifications of the local or remote workers where the models are going to be processed must be specified through the `workers` argument. The following options are available:

  ##### 1) Using local machines
  ```{r}
  ## single local machine
  workers <- "localhost"
  # or 
  workers <- Sys.info()[["nodename"]]
  
  ## multiple local machines 
  workers <- rep("localhost", 2)  # two local machines
  workers <- future::availableWorkers()  # total number of available workers
  ```
  
  ##### 2) Using remote compute nodes
  ```{r}
  ## single remote machine
  workers <- "172.0.0.1"  # using IP address
  workers <- "machine1.remote.es"  # using hostname
  
  ## multiple remote machines
  workers <- c("172.0.0.1","172.0.0.2")
  # or
  workers <- c("machine1.remote.es","machine2.remote.es")
  ```
  
  ##### 3) Using both local and remote machines
  ```{r}
  workers <- c("localhost","172.0.0.1","172.0.0.2")
  ```
  
  ##### 4) It is also possible to fit more than one model simultaneously in each remote machine by setting
  ```{r}
  ## two models per remote machine
  workers <- rep(c("172.0.0.1","172.0.0.2"), each=2)
  
  ## two models per local and remote machines
  workers <- rep(c("localhost","172.0.0.1","172.0.0.2"), each=2)
  ```
  
  __Important note__: To work with remote workers, public and private keys between the different machines must be previously configured. In addition, the _bigDM_ package needs to be installed in all the local/remote machines. More details can be found at this [vignette](https://cran.r-project.org/web/packages/future/vignettes/future-3-topologies.html) and in the documentation of the [`makeClusterPSOCK`](https://www.rdocumentation.org/packages/future/versions/1.18.0/topics/makeClusterPSOCK) function.
  

## Example: Spanish colorectal cancer mortality data {-#example}

In what follows, we show how to fit the _Disjoint model_ for the Spanish colorectal cancer mortality data using different computation strategies. A full description of the data and usage of the `CAR_INLA()` function is given in the vignette [__bigDM: fitting spatial models__](https://emi-sstcdapp.unavarra.es/bigDM/bigDM-1-fitting-spatial-models.html).

```{r message=FALSE}
library(bigDM)
data(Carto_SpainMUN)

head(Carto_SpainMUN)
```
For our example data in `Carto_SpainMUN` the $D=15$ Autonomous Regions of Spain are used as a partition of the $n=7907$ municipalites (`region` variable of the `sf` object).

<br>
 
__1. Run the models sequentially in the current R session (default option)__
```{r}
Model1 <- CAR_INLA(carto=Carto_SpainMUN, ID.area="ID", ID.group="region", O="obs", E="exp",
                   model="partition", k=0, seed=1234, strategy="simplified.laplace",
                   plan="sequential", workers=NULL)

summary(Model1)
```


__2. Run the models in parallel on external R sessions__
```{r}
workers <- rep("localhost", 4)

Model2 <- CAR_INLA(carto=Carto_SpainMUN, ID.area="ID", ID.group="region", O="obs", E="exp",
                   model="partition", k=0, seed=1234, strategy="simplified.laplace",
                   plan="cluster", workers=workers)

summary(Model2)
```

The decision of how many models to process in parallel depends on the available computational resources. However, the more the models to be fitted in parallel, the more the R sessions to be opened in the backend, which would increase the computational time for data transfer.


__3. Run the models distributed in remote machines__

Before evaluating the following code, the user must set appropriate identifications for the remote machines.
```{r, eval=FALSE}
## Example of distributed computation with four models per remote machine
workers <- rep(c("172.0.0.1","172.0.0.2","172.0.0.3"), each=4)
        
Model3 <- CAR_INLA(carto=Carto_SpainMUN, ID.area="ID", ID.group="region", O="obs", E="exp",
                   model="partition", k=0, seed=1234, strategy="simplified.laplace",
                   plan="cluster", workers=workers)
#> STEP 1: Pre-processing data
#> STEP 2: Fitting partition (k=0) model with INLA 
#> starting worker pid=1444 on localhost:11204 at 13:03:13.910
#> starting worker pid=1465 on localhost:11204 at 13:03:14.123
#> starting worker pid=1489 on localhost:11204 at 13:03:14.330
#> starting worker pid=1509 on localhost:11204 at 13:03:14.544
#> starting worker pid=14966 on localhost:11208 at 13:03:15.548
#> starting worker pid=14998 on localhost:11209 at 13:03:16.545
#> starting worker pid=15028 on localhost:11210 at 13:03:17.514
#> starting worker pid=15058 on localhost:11211 at 13:03:18.544
#> starting worker pid=12722 on localhost:11212 at 13:03:19.010
#> starting worker pid=12750 on localhost:11213 at 13:03:19.430
#> starting worker pid=12778 on localhost:11214 at 13:03:19.764
#> starting worker pid=12806 on localhost:11215 at 13:03:20.088
#> + Model 1 of 15 
#> + Model 2 of 15 
#> + Model 3 of 15 
#> + Model 4 of 15 
#> + Model 5 of 15 
#> + Model 6 of 15 
#> + Model 7 of 15 
#> + Model 8 of 15 
#> + Model 9 of 15 
#> + Model 10 of 15 
#> + Model 11 of 15 
#> + Model 12 of 15 
#> + Model 13 of 15 
#> + Model 14 of 15 
#> + Model 15 of 15 
#> STEP 3: Merging the results

summary(Model3)

#> Call:
#>    c("inla(formula = formula, family = \"poisson\", data = data.INLA, ", " E = E, 
#>    control.compute = list(dic = TRUE, cpo = TRUE, waic = TRUE, ", " config = TRUE), 
#>    control.predictor = list(compute = TRUE, ", " cdf = c(log(1))), control.inla = 
#>    list(strategy = strategy))" ) 
#> Time used:
#>     Running = 111, Merging = 16.7, Total = 128, NA = NA 
#> Random effects:
#>   Name	  Model
#>     ID.area Generic1 model
#> 
#> Deviance Information Criterion (DIC) ...............: 27450.60
#> Deviance Information Criterion (DIC, saturated) ....: 8387.16
#> Effective number of parameters .....................: 403.90
#> 
#> Watanabe-Akaike information criterion (WAIC) ...: 27433.63
#> Effective number of parameters .................: 343.31
#> 
#> Posterior marginals for the linear predictor and
#>  the fitted values are computed
```

## Acknowledgments {-#acknowledgments}
This work has been supported by the Spanish Ministry of Economy, Industry, and Competitiveness (project MTM2017-82553-R, AEI/FEDER, UE), and partially funded by la Caixa Foundation (ID 1000010434), Caja Navarra Foundation and UNED Pamplona, under agreement LCF/PR/PR15/51100007 (project REF P/13/20).


## References
